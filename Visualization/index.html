<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>SCAN Cognitive Architecture - Interactive Flow</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600;700;800&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neural-deep: #18181b;
            --neural-dark: #1e1e24;
            --neural-card: #27272a;
            --neural-surface: #2e2e33;
            --neural-border: rgba(255, 255, 255, 0.08);
            
            --accent-blue: #4361ee;
            --accent-cyan: #4cc9f0;
            --accent-purple: #7209b7;
            --accent-pink: #f72585;
            --accent-orange: #ff6d00;
            --accent-green: #10b981;
            
            --text-primary: #f4f4f5;
            --text-secondary: #cbd5e0;
            --text-muted: #71717a;
            
            --ease-premium: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-spring: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--neural-deep);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Mesh gradient background */
        .bg-mesh {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            background: 
                radial-gradient(at 40% 20%, rgba(67, 97, 238, 0.12) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(76, 201, 240, 0.10) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(114, 9, 183, 0.08) 0px, transparent 50%),
                radial-gradient(at 80% 50%, rgba(247, 37, 133, 0.06) 0px, transparent 50%),
                radial-gradient(at 20% 80%, rgba(16, 185, 129, 0.08) 0px, transparent 50%);
        }

        /* Back Navigation */
        .back-nav {
            position: relative;
            z-index: 10;
            padding: 0.35rem 0.5rem;
            background: rgba(24, 24, 27, 0.9);
            border-bottom: 1px solid var(--neural-border);
        }
        
        .back-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .back-nav li {
            display: inline-block;
        }
        
        .back-nav a {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--accent-cyan);
            text-decoration: none;
            font-size: 0.7rem;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            min-height: 44px;
            transition: all 0.2s ease;
        }
        
        .back-nav a:hover,
        .back-nav a:active {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.08);
        }
        
        /* Tablet and up */
        @media (min-width: 768px) {
            .back-nav {
                padding: 0.4rem 1rem;
            }
            
            .back-nav a {
                font-size: 0.8rem;
                min-height: auto;
                padding: 0.4rem 0.75rem;
            }
        }

        .glass-card {
            background: rgba(39, 39, 42, 0.4);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid var(--neural-border);
        }

        .gradient-text {
            background: linear-gradient(135deg, #4361ee 0%, #4cc9f0 50%, #7209b7 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 6s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.9; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-12px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes particleMove {
            0% { offset-distance: 0%; opacity: 1; }
            100% { offset-distance: 100%; opacity: 0.6; }
        }

        .premium-btn {
            background: linear-gradient(135deg, #4361ee 0%, #4cc9f0 50%, #7209b7 100%);
            background-size: 200% 200%;
            border: none;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.4s var(--ease-premium);
        }

        .premium-btn:hover {
            background-position: 100% 50%;
            box-shadow: 0 8px 32px rgba(67, 97, 238, 0.4);
            transform: translateY(-2px);
        }

        /* Header */
        header {
            position: relative;
            z-index: 10;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--neural-border);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title h1 {
            font-family: 'Bricolage Grotesque', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
        }

        .header-title p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-family: monospace;
            font-weight: 600;
        }

        .status-dot {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            position: relative;
            z-index: 10;
        }

        .viz-container {
            flex: 1;
            padding: 1rem;
        }

        .svg-wrapper {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        #mainSvg {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Controls */
        .controls {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background: rgba(39, 39, 42, 0.6);
            color: var(--text-secondary);
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.05);
        }

        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .control-btn.play-btn {
            padding: 0.5rem 2rem;
        }

        .control-btn.restart-btn {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .speed-control label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .speed-control input[type="range"] {
            width: 6rem;
            accent-color: var(--accent-cyan);
        }

        .step-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background: rgba(39, 39, 42, 0.6);
            font-size: 0.875rem;
        }

        .step-indicator .current {
            font-weight: 700;
            color: var(--text-primary);
        }

        .step-indicator .total {
            color: var(--text-muted);
        }
        
        /* Mobile gesture hints */
        .mobile-hints {
            display: none;
            justify-content: center;
            gap: 1.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .mobile-hints span {
            white-space: nowrap;
        }
        
        @media (hover: none) and (pointer: coarse) {
            .mobile-hints {
                display: flex;
                flex-wrap: wrap;
            }
        }

        /* Side Panel */
        .side-panel {
            width: 380px;
            border-left: 1px solid var(--neural-border);
            padding: 1.25rem;
            overflow-y: auto;
            max-height: calc(100vh - 73px);
        }

        .panel-section {
            margin-bottom: 1.5rem;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .phase-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .step-label {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .panel-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .note-box {
            padding: 1rem;
            border-radius: 0.75rem;
            background: rgba(255, 109, 0, 0.08);
            border: 1px solid rgba(255, 109, 0, 0.25);
        }

        .note-box p {
            font-size: 0.75rem;
            color: #ff9e40;
        }

        .load-bar-container {
            padding: 1rem;
            border-radius: 0.75rem;
            background: rgba(39, 39, 42, 0.4);
        }

        .load-bar-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .load-bar-header .label {
            color: var(--text-muted);
        }

        .load-bar-header .value {
            font-weight: 600;
        }

        .load-bar {
            height: 0.5rem;
            border-radius: 0.25rem;
            background: rgba(39, 39, 42, 0.8);
            overflow: hidden;
        }

        .load-bar-fill {
            height: 100%;
            border-radius: 0.25rem;
            transition: width 0.5s ease, background 0.5s ease;
        }

        .section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .ops-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .op-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: rgba(39, 39, 42, 0.4);
            color: var(--text-secondary);
            animation: slideIn 0.3s ease both;
        }

        .op-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
        }

        .active-components {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .component-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .data-flow-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: rgba(39, 39, 42, 0.4);
        }

        .flow-arrow {
            color: var(--text-muted);
        }

        .flow-label {
            margin-left: auto;
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .hitl-box {
            padding: 1rem;
            border-radius: 0.75rem;
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.25);
        }

        .hitl-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .hitl-header span:first-child {
            font-size: 1.25rem;
        }

        .hitl-header span:last-child {
            font-weight: 700;
            font-size: 0.875rem;
            color: #34d399;
        }

        .hitl-description {
            font-size: 0.75rem;
            color: rgba(52, 211, 153, 0.9);
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }

        .hitl-functions {
            padding-top: 0.75rem;
            border-top: 1px solid rgba(16, 185, 129, 0.2);
        }

        .hitl-functions-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(52, 211, 153, 0.8);
            margin-bottom: 0.5rem;
        }

        .hitl-functions ul {
            list-style: none;
            font-size: 0.75rem;
            color: rgba(52, 211, 153, 0.7);
        }

        .hitl-functions li {
            margin-bottom: 0.25rem;
        }

        .legend {
            padding-top: 1.25rem;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 0.25rem;
        }

        .legend-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .legend-hitl {
            grid-column: span 2;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.04);
        }

        .legend-hitl .legend-color {
            border-radius: 50%;
        }

        /* Toggle button */
        .toggle-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #4361ee 0%, #4cc9f0 50%, #7209b7 100%);
            color: white;
        }

        .toggle-btn:not(.active) {
            background: rgba(39, 39, 42, 0.4);
            border: 1px solid var(--neural-border);
            color: var(--text-secondary);
        }

        .toggle-btn:not(.active):hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Responsive */
        /* ===========================================
           MOBILE-FIRST RESPONSIVE DESIGN
           =========================================== */
        
        /* Base mobile styles (default) */
        header {
            padding: 0.5rem 0.75rem;
        }
        
        .header-content {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .header-title h1 {
            font-size: 1rem;
        }
        
        .header-title p {
            font-size: 0.6rem;
        }
        
        .header-controls {
            width: 100%;
            justify-content: space-between;
        }
        
        .status-badge {
            padding: 0.35rem 0.6rem;
            font-size: 0.7rem;
        }
        
        .toggle-btn {
            padding: 0.35rem 0.6rem;
            font-size: 0.7rem;
        }
        
        .main-container {
            flex-direction: column;
        }
        
        .viz-container {
            padding: 0.5rem;
            width: 100%;
        }
        
        .svg-wrapper {
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        #mainSvg {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .step-timeline {
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .timeline-header {
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }
        
        .timeline-title {
            font-size: 0.6rem;
        }
        
        .phase-legend-item {
            font-size: 0.5rem;
        }
        
        .phase-legend-dot {
            width: 6px;
            height: 6px;
        }
        
        .timeline-track {
            height: 40px;
        }
        
        .timeline-step {
            width: 20px;
            height: 20px;
        }
        
        .timeline-step-number {
            font-size: 0.45rem;
        }
        
        .timeline-step-tooltip {
            display: none;
        }
        
        .controls {
            padding: 0.5rem;
            margin-top: 0.5rem;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-group {
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.4rem;
        }
        
        .control-btn {
            padding: 0.6rem 0.8rem;
            font-size: 0.75rem;
            min-height: 44px;
            border-radius: 0.5rem;
        }
        
        .premium-btn {
            padding: 0.6rem 1rem;
            min-height: 44px;
        }
        
        .speed-control {
            width: 100%;
            justify-content: center;
        }
        
        .speed-control label {
            font-size: 0.75rem;
        }
        
        .speed-control input[type="range"] {
            width: 80px;
        }
        
        .step-indicator {
            font-size: 0.75rem;
            justify-content: center;
        }
        
        /* Side panel as bottom drawer on mobile */
        .side-panel {
            display: none;
            width: 100%;
            max-height: 40vh;
            border-left: none;
            border-top: 1px solid var(--neural-border);
            padding: 0.75rem;
            overflow-y: auto;
        }
        
        .side-panel.visible {
            display: block;
        }
        
        .panel-section {
            margin-bottom: 0.75rem;
        }
        
        .panel-title {
            font-size: 0.95rem;
        }
        
        .panel-description {
            font-size: 0.75rem;
        }
        
        .section-title {
            font-size: 0.6rem;
        }
        
        .load-bar {
            height: 6px;
        }
        
        .op-item {
            font-size: 0.7rem;
            padding: 0.3rem 0.5rem;
        }
        
        .component-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
        }
        
        .data-flow-item {
            font-size: 0.7rem;
        }
        
        /* Mobile hints visible by default on mobile */
        .mobile-hints {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.4rem;
            font-size: 0.6rem;
            color: var(--text-muted);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* Tablet and up (min-width: 768px) */
        @media (min-width: 768px) {
            header {
                padding: 0.75rem 1.25rem;
            }
            
            .header-content {
                flex-direction: row;
                gap: 1rem;
            }
            
            .header-title h1 {
                font-size: 1.3rem;
            }
            
            .header-title p {
                font-size: 0.7rem;
            }
            
            .header-controls {
                width: auto;
            }
            
            .status-badge {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            
            .viz-container {
                padding: 1rem;
            }
            
            .step-timeline {
                padding: 1rem;
            }
            
            .timeline-step {
                width: 18px;
                height: 18px;
            }
            
            .timeline-step-tooltip {
                display: block;
            }
            
            .controls {
                flex-direction: row;
                padding: 1rem;
            }
            
            .control-group {
                width: auto;
            }
            
            .mobile-hints {
                display: none;
            }
        }
        
        /* Desktop (min-width: 1024px) */
        @media (min-width: 1024px) {
            header {
                padding: 1rem 1.5rem;
            }
            
            .header-title h1 {
                font-size: 1.5rem;
            }
            
            .main-container {
                flex-direction: row;
            }
            
            .side-panel {
                display: block;
                width: 380px;
                max-height: calc(100vh - 73px);
                border-left: 1px solid var(--neural-border);
                border-top: none;
            }
            
            .side-panel.visible {
                display: block;
            }
            
            .toggle-btn {
                display: none;
            }
        }
        
        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .control-btn:active {
                transform: scale(0.95);
                opacity: 0.8;
            }
            
            .premium-btn:active {
                transform: scale(0.95);
            }
            
            .timeline-step:active {
                transform: scale(1.3);
            }
        }

        /* SVG specific styles */
        .node-rect {
            transition: all 0.4s var(--ease-premium);
        }

        .node-text {
            transition: fill 0.4s ease;
        }

        .arrow-line {
            animation: fadeIn 0.4s ease;
        }

        .particle {
            animation: particleMove 1.2s linear infinite;
        }
    </style>
</head>
<body>
    <div class="bg-mesh"></div>

    <!-- Back Navigation -->
    <nav class="back-nav">
        <ul>
            <li><a href="../index.html">‚Üê Back to Main Page</a></li>
        </ul>
    </nav>

    <header class="glass-card">
        <div class="header-content">
            <div class="header-title">
                <h1 class="gradient-text">SCAN Cognitive Architecture</h1>
                <p>Synthetic Cognitive Augmentation Network ‚Äî Complete Interaction Flow</p>
            </div>
            <div class="header-controls">
                <div class="status-badge glass-card">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">IDLE</span>
                </div>
                <button class="toggle-btn active" id="togglePanel" onclick="togglePanel()">
                    Hide Panel
                </button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="viz-container">
            <div class="svg-wrapper glass-card">
                <svg id="mainSvg" viewBox="0 0 820 560" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <!-- Grid pattern for technical look -->
                        <pattern id="gridPattern" width="40" height="40" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(255,255,255,0.02)" stroke-width="1"/>
                        </pattern>
                        <pattern id="dotPattern" width="20" height="20" patternUnits="userSpaceOnUse">
                            <circle cx="10" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/>
                        </pattern>
                        
                        <!-- Gradients for nodes -->
                        <linearGradient id="gradient-user" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#ff6d00"/>
                            <stop offset="100%" stop-color="#ff9e40" stop-opacity="0.8"/>
                        </linearGradient>
                        <linearGradient id="gradient-dlpfc" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#4361ee"/>
                            <stop offset="100%" stop-color="#6b8cff" stop-opacity="0.8"/>
                        </linearGradient>
                        <linearGradient id="gradient-vmpfc" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#10b981"/>
                            <stop offset="100%" stop-color="#34d399" stop-opacity="0.8"/>
                        </linearGradient>
                        <linearGradient id="gradient-ofc" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#7209b7"/>
                            <stop offset="100%" stop-color="#9d4edd" stop-opacity="0.8"/>
                        </linearGradient>
                        <linearGradient id="gradient-acc" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#f72585"/>
                            <stop offset="100%" stop-color="#ff5ca2" stop-opacity="0.8"/>
                        </linearGradient>
                        <linearGradient id="gradient-mpfc" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#4cc9f0"/>
                            <stop offset="100%" stop-color="#7edcf7" stop-opacity="0.8"/>
                        </linearGradient>
                        <linearGradient id="gradient-integration" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#9d4edd"/>
                            <stop offset="100%" stop-color="#c77dff" stop-opacity="0.8"/>
                        </linearGradient>
                        <linearGradient id="gradient-hitl" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#10b981"/>
                            <stop offset="100%" stop-color="#34d399" stop-opacity="0.8"/>
                        </linearGradient>
                        <linearGradient id="glassHighlight" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stop-color="rgba(255, 255, 255, 0.2)"/>
                            <stop offset="100%" stop-color="rgba(255, 255, 255, 0)"/>
                        </linearGradient>
                        
                        <!-- Grid pattern -->
                        <pattern id="grid" width="30" height="30" patternUnits="userSpaceOnUse">
                            <path d="M 30 0 L 0 0 0 30" fill="none" stroke="rgba(255,255,255,0.02)" stroke-width="1"/>
                        </pattern>
                    </defs>

                    <!-- Background with grid pattern -->
                    <rect width="100%" height="100%" fill="#18181b"/>
                    <rect width="100%" height="100%" fill="url(#gridPattern)"/>
                    <rect width="100%" height="100%" fill="url(#dotPattern)"/>

                    <!-- Column labels -->
                    <g opacity="0.5" font-size="9" font-weight="bold" letter-spacing="2" fill="#71717a">
                        <text x="100" y="40" text-anchor="middle">USER</text>
                        <text x="280" y="40" text-anchor="middle">EXECUTIVE</text>
                        <text x="480" y="40" text-anchor="middle">COGNITIVE</text>
                        <text x="680" y="40" text-anchor="middle">SYNTHESIS</text>
                    </g>

                    <!-- Loop indicator (hidden by default) -->
                    <g id="loopIndicator" style="display: none;">
                        <rect x="395" y="55" width="170" height="450" rx="20" fill="rgba(247, 37, 133, 0.03)" stroke="rgba(247, 37, 133, 0.3)" stroke-width="2" stroke-dasharray="12 6"/>
                        <g transform="translate(480, 520)">
                            <rect x="-60" y="-12" width="120" height="24" rx="6" fill="rgba(247, 37, 133, 0.15)" stroke="rgba(247, 37, 133, 0.3)" stroke-width="1"/>
                            <text text-anchor="middle" y="5" fill="#f72585" font-size="10" font-weight="bold">‚ü≥ PROCESS LOOP</text>
                        </g>
                        <text id="loopLabel" x="480" y="546" text-anchor="middle" fill="rgba(247, 37, 133, 0.6)" font-size="8"></text>
                    </g>

                    <!-- HITL Bridge label (hidden by default) -->
                    <g id="hitlBridgeLabel" transform="translate(190, 95)" style="display: none;">
                        <text text-anchor="middle" fill="rgba(16, 185, 129, 0.7)" font-size="9" font-weight="bold" letter-spacing="1">‚Üì FEEDBACK BRIDGE ‚Üì</text>
                    </g>

                    <!-- Connection guidelines -->
                    <g opacity="0.05" stroke="#fff" stroke-width="1" stroke-dasharray="4 8">
                        <line x1="165" y1="300" x2="215" y2="300"/>
                        <line x1="345" y1="300" x2="415" y2="100"/>
                        <line x1="345" y1="300" x2="415" y2="220"/>
                        <line x1="345" y1="300" x2="415" y2="340"/>
                        <line x1="345" y1="300" x2="415" y2="460"/>
                        <line x1="545" y1="100" x2="615" y2="280"/>
                        <line x1="545" y1="220" x2="615" y2="280"/>
                        <line x1="545" y1="340" x2="615" y2="280"/>
                        <line x1="545" y1="460" x2="615" y2="280"/>
                    </g>

                    <!-- Arrows container -->
                    <g id="arrowsContainer"></g>

                    <!-- Particles container -->
                    <g id="particlesContainer"></g>

                    <!-- HITL Node (hidden by default) -->
                    <g id="hitlNode" transform="translate(190, 160)" style="display: none;">
                        <ellipse cx="0" cy="0" rx="65" ry="40" fill="rgba(16, 185, 129, 0.3)" opacity="0.5"/>
                        <line x1="-45" y1="35" x2="-75" y2="100" stroke="#10b981" stroke-width="1.5" stroke-dasharray="4 4" opacity="0.4"/>
                        <line x1="45" y1="35" x2="75" y2="100" stroke="#10b981" stroke-width="1.5" stroke-dasharray="4 4" opacity="0.4"/>
                        <rect x="-55" y="-32" width="110" height="64" rx="32" fill="url(#gradient-hitl)" stroke="#10b981" stroke-width="1.5"/>
                        <rect x="-60" y="-37" width="120" height="74" rx="37" fill="none" stroke="#10b981" stroke-width="1" opacity="0.3" style="animation: pulse 2s ease-in-out infinite;"/>
                        <!-- SVG refresh icon -->
                        <g transform="translate(-10, -14) scale(0.85)">
                            <path d="M12 6v3l4-4-4-4v3c-4.4 0-8 3.6-8 8 0 1.6.5 3.1 1.3 4.4l1.5-1.5C6.3 13.1 6 12.1 6 11c0-3.3 2.7-6 6-6zm6.7 1.6l-1.5 1.5c.5.8.8 1.8.8 2.9 0 3.3-2.7 6-6 6v-3l-4 4 4 4v-3c4.4 0 8-3.6 8-8 0-1.6-.5-3.1-1.3-4.4z" fill="#10b981"/>
                        </g>
                        <text y="18" text-anchor="middle" fill="#fff" font-size="11" font-weight="600" letter-spacing="0.5">HITL</text>
                        <g transform="translate(0, -55)">
                            <rect x="-58" y="-10" width="116" height="20" rx="4" fill="rgba(16, 185, 129, 0.12)" stroke="rgba(16, 185, 129, 0.25)" stroke-width="1"/>
                            <text text-anchor="middle" y="4" fill="#34d399" font-size="8" font-weight="500" letter-spacing="0.3">Human-in-the-Loop</text>
                        </g>
                    </g>

                    <!-- Nodes -->
                    <g id="nodeUser" transform="translate(100, 300)"></g>
                    <g id="nodeDlpfc" transform="translate(280, 300)"></g>
                    <g id="nodeVmpfc" transform="translate(480, 100)"></g>
                    <g id="nodeOfc" transform="translate(480, 220)"></g>
                    <g id="nodeAcc" transform="translate(480, 340)"></g>
                    <g id="nodeMpfc" transform="translate(480, 460)"></g>
                    <g id="nodeIntegration" transform="translate(680, 280)"></g>
                    
                    <!-- Labels container (rendered last to be on top) -->
                    <g id="labelsContainer"></g>

                    <!-- Progress bar -->
                    <g transform="translate(40, 545)">
                        <rect x="0" y="0" width="740" height="6" rx="3" fill="rgba(255,255,255,0.06)"/>
                        <rect id="progressBar" x="0" y="0" width="6" height="6" rx="3" fill="url(#gradient-dlpfc)" style="transition: width 0.4s ease;"/>
                    </g>
                </svg>
            </div>

            <!-- Controls -->
            <div class="controls glass-card">
                <div class="control-group">
                    <button class="control-btn" onclick="resetAnimation()">‚ü≤ Reset</button>
                    <button class="control-btn" id="prevBtn" onclick="prevStep()" disabled>‚Üê Prev</button>
                    <button class="control-btn play-btn premium-btn" id="playBtn" onclick="togglePlay()">‚ñ∂ Play</button>
                    <button class="control-btn" id="nextBtn" onclick="nextStep()">Next ‚Üí</button>
                    <button class="control-btn restart-btn" id="restartBtn" onclick="restartCycle()" style="display: none;">üîÑ New Cycle</button>
                </div>
                <div class="control-group">
                    <div class="speed-control">
                        <label>Speed:</label>
                        <input type="range" id="speedSlider" min="800" max="4000" step="200" value="2600" onchange="updateSpeed()">
                    </div>
                    <div class="step-indicator">
                        <span class="total">Step</span>
                        <span class="current" id="currentStepDisplay">-</span>
                        <span class="total">of 22</span>
                    </div>
                </div>
            </div>
            
            <!-- Mobile gesture hints (visible only on touch devices) -->
            <div class="mobile-hints" id="mobileHints">
                <span>üëÜ Tap steps</span>
                <span>üëàüëâ Swipe</span>
                <span>üëÜüëÜ Double-tap play</span>
            </div>
        </div>

        <!-- Side Panel -->
        <div class="side-panel glass-card visible" id="sidePanel">
            <div class="panel-section">
                <div class="panel-header">
                    <span class="phase-badge" id="phaseBadge">Initialization</span>
                    <span class="step-label" id="stepLabel">Step -</span>
                </div>
                <h2 class="panel-title" id="panelTitle">System Ready</h2>
                <p class="panel-description" id="panelDescription">The SCAN cognitive architecture is initialized and awaiting user input.</p>
            </div>

            <div class="panel-section" id="noteSection" style="display: none;">
                <div class="note-box">
                    <p id="noteText"></p>
                </div>
            </div>

            <div class="panel-section">
                <div class="load-bar-container">
                    <div class="load-bar-header">
                        <span class="label">System Load</span>
                        <span class="value" id="loadValue">0%</span>
                    </div>
                    <div class="load-bar">
                        <div class="load-bar-fill" id="loadBarFill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <div class="panel-section" id="opsSection" style="display: none;">
                <h3 class="section-title">Internal Operations</h3>
                <div class="ops-list" id="opsList"></div>
            </div>

            <div class="panel-section" id="activeSection" style="display: none;">
                <h3 class="section-title">Active Components</h3>
                <div class="active-components" id="activeComponents"></div>
            </div>

            <div class="panel-section" id="flowSection" style="display: none;">
                <h3 class="section-title">Data Flow</h3>
                <div id="dataFlowList"></div>
            </div>

            <div class="panel-section" id="hitlSection" style="display: none;">
                <div class="hitl-box">
                    <div class="hitl-header">
                        <span>üîÑ</span>
                        <span>Human-in-the-Loop</span>
                    </div>
                    <p class="hitl-description">HITL is the critical feedback bridge between User and DLPFC. It enables continuous learning, ensures AI alignment with human values, and allows for real-time correction of system behavior.</p>
                    <div class="hitl-functions">
                        <div class="hitl-functions-title">Key Functions:</div>
                        <ul>
                            <li>‚Ä¢ Collects qualitative feedback on responses</li>
                            <li>‚Ä¢ Assesses response quality and relevance</li>
                            <li>‚Ä¢ Generates learning signals for model improvement</li>
                            <li>‚Ä¢ Enables personalization over time</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="panel-section legend">
                <h3 class="section-title">Legend</h3>
                <div class="legend-grid">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6d00;"></div>
                        <span class="legend-label">User</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4361ee;"></div>
                        <span class="legend-label">DLPFC</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #10b981;"></div>
                        <span class="legend-label">VMPFC</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #7209b7;"></div>
                        <span class="legend-label">OFC</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f72585;"></div>
                        <span class="legend-label">ACC</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4cc9f0;"></div>
                        <span class="legend-label">mPFC</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9d4edd;"></div>
                        <span class="legend-label">Integration</span>
                    </div>
                    <div class="legend-item legend-hitl">
                        <div class="legend-color" style="background: #10b981;"></div>
                        <span class="legend-label">HITL (Human-in-the-Loop)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const colors = {
            user: { primary: '#ff6d00', secondary: '#ff9e40', glow: 'rgba(255, 109, 0, 0.4)' },
            dlpfc: { primary: '#4361ee', secondary: '#6b8cff', glow: 'rgba(67, 97, 238, 0.4)' },
            vmpfc: { primary: '#10b981', secondary: '#34d399', glow: 'rgba(16, 185, 129, 0.4)' },
            ofc: { primary: '#7209b7', secondary: '#9d4edd', glow: 'rgba(114, 9, 183, 0.4)' },
            acc: { primary: '#f72585', secondary: '#ff5ca2', glow: 'rgba(247, 37, 133, 0.4)' },
            mpfc: { primary: '#4cc9f0', secondary: '#7edcf7', glow: 'rgba(76, 201, 240, 0.4)' },
            integration: { primary: '#9d4edd', secondary: '#c77dff', glow: 'rgba(157, 77, 221, 0.4)' },
            hitl: { primary: '#10b981', secondary: '#34d399', glow: 'rgba(16, 185, 129, 0.5)' }
        };

        const nodeInfo = {
            user: { name: 'User', icon: 'user', fullName: 'Human Operator', description: 'Initiates queries and provides feedback through HITL mechanism' },
            dlpfc: { name: 'DLPFC', icon: 'brain', fullName: 'Dorsolateral Prefrontal Cortex', description: 'Executive control, task parsing, working memory management' },
            vmpfc: { name: 'VMPFC', icon: 'scale', fullName: 'Ventromedial Prefrontal Cortex', description: 'Value-based decisions, emotional regulation, risk assessment' },
            ofc: { name: 'OFC', icon: 'gem', fullName: 'Orbitofrontal Cortex', description: 'Reward processing, outcome evaluation, utility computation' },
            acc: { name: 'ACC', icon: 'zap', fullName: 'Anterior Cingulate Cortex', description: 'Conflict monitoring, error detection, attention allocation' },
            mpfc: { name: 'mPFC', icon: 'thought', fullName: 'Medial Prefrontal Cortex', description: 'Self-reference, social cognition, metacognitive awareness' },
            integration: { name: 'Integration', icon: 'layers', fullName: 'Synthesis Module', description: 'Aggregates outputs into coherent unified response' },
            hitl: { name: 'HITL', icon: 'refresh', fullName: 'Human-in-the-Loop', description: 'Feedback mechanism for continuous learning' }
        };
        
        // Professional SVG icon paths
        const iconPaths = {
            user: 'M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v2h20v-2c0-3.3-6.7-5-10-5z',
            brain: 'M12 2C9.5 2 7.4 3.6 6.7 5.8 4.7 6.3 3.2 8 3 10.1c-.3 2.5 1 4.9 3.2 6 .1 1.8 1 3.4 2.5 4.5.7.5 1.5.9 2.3 1.1V24h2v-2.3c.8-.2 1.6-.6 2.3-1.1 1.5-1.1 2.4-2.7 2.5-4.5 2.2-1.1 3.5-3.5 3.2-6-.2-2.1-1.7-3.8-3.7-4.3C16.6 3.6 14.5 2 12 2zm-1 4c.6 0 1 .4 1 1v2c0 .6-.4 1-1 1s-1-.4-1-1V7c0-.6.4-1 1-1zm4 0c.6 0 1 .4 1 1v2c0 .6-.4 1-1 1s-1-.4-1-1V7c0-.6.4-1 1-1z',
            scale: 'M12 3L2 8l10 5 10-5-10-5zM2 12l10 5 10-5M2 17l10 5 10-5',
            gem: 'M12 2L2 9l10 13 10-13-10-7zm0 4l6 4.5L12 18 6 10.5 12 6z',
            zap: 'M13 2L3 14h9l-1 8 10-12h-9l1-8z',
            thought: 'M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8 13c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1-.4 1-1 1zm1.1-4.1c-.4.4-.6.8-.6 1.1h-1c0-.7.3-1.3.8-1.8.5-.5.7-.9.7-1.4 0-.8-.7-1.3-1.5-1.3s-1.5.6-1.5 1.3H9c0-1.4 1.1-2.5 2.5-2.5s2.5 1.1 2.5 2.5c0 .7-.3 1.3-.9 2.1z',
            layers: 'M12 2L2 7l10 5 10-5-10-5zM2 12l10 5 10-5M2 17l10 5 10-5',
            refresh: 'M12 6v3l4-4-4-4v3c-4.4 0-8 3.6-8 8 0 1.6.5 3.1 1.3 4.4l1.5-1.5C6.3 13.1 6 12.1 6 11c0-3.3 2.7-6 6-6zm6.7 1.6l-1.5 1.5c.5.8.8 1.8.8 2.9 0 3.3-2.7 6-6 6v-3l-4 4 4 4v-3c4.4 0 8-3.6 8-8 0-1.6-.5-3.1-1.3-4.4z'
        };

        const positions = {
            user: { x: 100, y: 300 },
            dlpfc: { x: 280, y: 300 },
            hitl: { x: 190, y: 160 },
            vmpfc: { x: 480, y: 100 },
            ofc: { x: 480, y: 220 },
            acc: { x: 480, y: 340 },
            mpfc: { x: 480, y: 460 },
            integration: { x: 680, y: 280 }
        };

        const stateColors = {
            IDLE: '#71717a',
            INPUT: '#ff6d00',
            PARSING: '#4361ee',
            DELEGATING: '#7209b7',
            LOOP: '#f72585',
            TRANSMITTING: '#10b981',
            INTEGRATING: '#9d4edd',
            DELIVERING: '#4cc9f0',
            HITL: '#10b981',
            UPDATING: '#4361ee',
            READY: '#10b981'
        };

        // Steps data
        const steps = [
            { id: 0, step: '-', phase: 'Initialization', title: 'System Ready', description: 'The SCAN cognitive architecture is initialized and awaiting user input. All neural modules are in standby mode.', active: [], arrows: [], dataFlow: [], systemState: 'IDLE', processingLoad: 0, duration: 1 },
            { id: 1, step: '1', phase: 'Input', title: 'Submit Question or Input', description: 'User submits a natural language query or task request to the DLPFC (Dorsolateral Prefrontal Cortex).', active: ['user', 'dlpfc'], arrows: [{ from: 'user', to: 'dlpfc', label: 'Submit Question or Input' }], dataFlow: [{ from: 'user', to: 'dlpfc' }], systemState: 'INPUT', processingLoad: 15, note: 'User activates ‚Üí DLPFC activates ‚Üí User deactivates', duration: 1 },
            { id: 2, step: '2', phase: 'Parsing', title: 'Parse Task', description: 'DLPFC performs internal task parsing - analyzing the input, identifying intent, and preparing for decomposition.', active: ['dlpfc'], selfArrows: ['dlpfc'], arrows: [], dataFlow: [], systemState: 'PARSING', processingLoad: 30, internalOps: ['Tokenization', 'Intent Classification', 'Entity Extraction', 'Task Analysis'], duration: 1 },
            { id: 3, step: '3', phase: 'Delegation', title: 'Delegate VMPFC Subtask', description: 'DLPFC delegates the value assessment subtask to VMPFC for emotional valence and preference evaluation.', active: ['dlpfc', 'vmpfc'], arrows: [{ from: 'dlpfc', to: 'vmpfc', label: 'Delegate VMPFC Subtask' }], dataFlow: [{ from: 'dlpfc', to: 'vmpfc' }], systemState: 'DELEGATING', processingLoad: 35, note: 'VMPFC activates', duration: 1 },
            { id: 4, step: '4', phase: 'Delegation', title: 'Delegate OFC Subtask', description: 'DLPFC delegates the reward processing subtask to OFC for utility computation and outcome prediction.', active: ['dlpfc', 'vmpfc', 'ofc'], arrows: [{ from: 'dlpfc', to: 'ofc', label: 'Delegate OFC Subtask' }], dataFlow: [{ from: 'dlpfc', to: 'ofc' }], systemState: 'DELEGATING', processingLoad: 40, note: 'OFC activates', duration: 1 },
            { id: 5, step: '5', phase: 'Delegation', title: 'Delegate ACC Subtask', description: 'DLPFC delegates the conflict monitoring subtask to ACC for error detection and attention allocation.', active: ['dlpfc', 'vmpfc', 'ofc', 'acc'], arrows: [{ from: 'dlpfc', to: 'acc', label: 'Delegate ACC Subtask' }], dataFlow: [{ from: 'dlpfc', to: 'acc' }], systemState: 'DELEGATING', processingLoad: 45, note: 'ACC activates', duration: 1 },
            { id: 6, step: '6', phase: 'Delegation', title: 'Delegate mPFC Subtask', description: 'DLPFC delegates the self-referential subtask to mPFC for metacognitive processing. DLPFC then deactivates.', active: ['dlpfc', 'vmpfc', 'ofc', 'acc', 'mpfc'], arrows: [{ from: 'dlpfc', to: 'mpfc', label: 'Delegate mPFC Subtask' }], dataFlow: [{ from: 'dlpfc', to: 'mpfc' }], systemState: 'DELEGATING', processingLoad: 50, note: 'mPFC activates ‚Üí DLPFC deactivates', duration: 1 },
            { id: 7, step: '7', phase: 'Processing Loop', title: 'Process VMPFC Subtask', description: 'Within the processing loop: VMPFC processes its value assessment subtask internally.', active: ['vmpfc', 'ofc', 'acc', 'mpfc'], selfArrows: ['vmpfc'], arrows: [], dataFlow: [], systemState: 'LOOP', processingLoad: 65, loop: true, loopLabel: 'VMPFC ‚Üí VMPFC: Process VMPFC Subtask', duration: 1 },
            { id: 8, step: '8', phase: 'Processing Loop', title: 'Process OFC Subtask', description: 'Within the processing loop: OFC processes its reward evaluation subtask internally.', active: ['vmpfc', 'ofc', 'acc', 'mpfc'], selfArrows: ['ofc'], arrows: [], dataFlow: [], systemState: 'LOOP', processingLoad: 75, loop: true, loopLabel: 'OFC ‚Üí OFC: Process OFC Subtask', duration: 1 },
            { id: 9, step: '9', phase: 'Processing Loop', title: 'Process ACC Subtask', description: 'Within the processing loop: ACC processes its conflict monitoring subtask internally.', active: ['vmpfc', 'ofc', 'acc', 'mpfc'], selfArrows: ['acc'], arrows: [], dataFlow: [], systemState: 'LOOP', processingLoad: 85, loop: true, loopLabel: 'ACC ‚Üí ACC: Process ACC Subtask', duration: 1 },
            { id: 10, step: '10', phase: 'Processing Loop', title: 'Process mPFC Subtask', description: 'Within the processing loop: mPFC processes its self-referential subtask internally.', active: ['vmpfc', 'ofc', 'acc', 'mpfc'], selfArrows: ['mpfc'], arrows: [], dataFlow: [], systemState: 'LOOP', processingLoad: 95, loop: true, loopLabel: 'mPFC ‚Üí mPFC: Process mPFC Subtask', duration: 1 },
            { id: 11, step: '11', phase: 'Result Transmission', title: 'VMPFC Result', description: 'VMPFC transmits its processed value assessment results to the Integration module, then deactivates.', active: ['vmpfc', 'ofc', 'acc', 'mpfc', 'integration'], arrows: [{ from: 'vmpfc', to: 'integration', label: 'VMPFC Result' }], dataFlow: [{ from: 'vmpfc', to: 'integration' }], systemState: 'TRANSMITTING', processingLoad: 80, note: 'Integration activates ‚Üí VMPFC deactivates', duration: 1 },
            { id: 12, step: '12', phase: 'Result Transmission', title: 'OFC Result', description: 'OFC transmits its reward processing results to the Integration module, then deactivates.', active: ['ofc', 'acc', 'mpfc', 'integration'], arrows: [{ from: 'ofc', to: 'integration', label: 'OFC Result' }], dataFlow: [{ from: 'ofc', to: 'integration' }], systemState: 'TRANSMITTING', processingLoad: 75, note: 'OFC deactivates', duration: 1 },
            { id: 13, step: '13', phase: 'Result Transmission', title: 'ACC Result', description: 'ACC transmits its conflict monitoring results to the Integration module, then deactivates.', active: ['acc', 'mpfc', 'integration'], arrows: [{ from: 'acc', to: 'integration', label: 'ACC Result' }], dataFlow: [{ from: 'acc', to: 'integration' }], systemState: 'TRANSMITTING', processingLoad: 70, note: 'ACC deactivates', duration: 1 },
            { id: 14, step: '14', phase: 'Result Transmission', title: 'mPFC Result', description: 'mPFC transmits its self-referential processing results to the Integration module, then deactivates.', active: ['mpfc', 'integration'], arrows: [{ from: 'mpfc', to: 'integration', label: 'mPFC Result' }], dataFlow: [{ from: 'mpfc', to: 'integration' }], systemState: 'TRANSMITTING', processingLoad: 65, note: 'mPFC deactivates', duration: 1 },
            { id: 15, step: '15', phase: 'Integration', title: 'Integrate Results', description: 'Integration module synthesizes all regional outputs into a coherent unified response.', active: ['integration'], selfArrows: ['integration'], arrows: [], dataFlow: [], systemState: 'INTEGRATING', processingLoad: 85, internalOps: ['Weighted Aggregation', 'Conflict Resolution', 'Coherence Check', 'Response Synthesis'], duration: 1 },
            { id: 16, step: '16', phase: 'Response Delivery', title: 'Deliver VMPFC Result', description: 'Integration delivers the VMPFC component result to the User.', active: ['integration', 'user'], arrows: [{ from: 'integration', to: 'user', label: 'VMPFC Result' }], dataFlow: [{ from: 'integration', to: 'user' }], systemState: 'DELIVERING', processingLoad: 55, note: 'User activates', duration: 1 },
            { id: 17, step: '17', phase: 'Response Delivery', title: 'Deliver OFC Result', description: 'Integration delivers the OFC component result to the User.', active: ['integration', 'user'], arrows: [{ from: 'integration', to: 'user', label: 'OFC Result' }], dataFlow: [{ from: 'integration', to: 'user' }], systemState: 'DELIVERING', processingLoad: 50, duration: 1 },
            { id: 18, step: '18', phase: 'Response Delivery', title: 'Deliver ACC Result', description: 'Integration delivers the ACC component result to the User.', active: ['integration', 'user'], arrows: [{ from: 'integration', to: 'user', label: 'ACC Result' }], dataFlow: [{ from: 'integration', to: 'user' }], systemState: 'DELIVERING', processingLoad: 45, duration: 1 },
            { id: 19, step: '19', phase: 'Response Delivery', title: 'Deliver mPFC Result', description: 'Integration delivers the mPFC component result to the User.', active: ['integration', 'user'], arrows: [{ from: 'integration', to: 'user', label: 'mPFC Result' }], dataFlow: [{ from: 'integration', to: 'user' }], systemState: 'DELIVERING', processingLoad: 40, duration: 1 },
            { id: 20, step: '20', phase: 'Response Delivery', title: 'Deliver Unified Response', description: 'Integration delivers the complete synthesized unified response to the User, then deactivates.', active: ['integration', 'user'], arrows: [{ from: 'integration', to: 'user', label: 'Unified Response', highlight: true }], dataFlow: [{ from: 'integration', to: 'user' }], systemState: 'DELIVERING', processingLoad: 35, note: 'Integration deactivates', duration: 1 },
            { id: 21, step: '21', phase: 'Human-in-the-Loop', title: 'Provide Feedback (HITL)', description: 'User provides feedback through the Human-in-the-Loop (HITL) mechanism. This critical step enables the system to learn from human evaluation, correct errors, and continuously improve alignment with user preferences and values.', active: ['user', 'hitl', 'dlpfc'], showHITL: true, arrows: [{ from: 'user', to: 'hitl', label: 'Feedback' }, { from: 'hitl', to: 'dlpfc', label: 'Learning Signal' }], dataFlow: [{ from: 'user', to: 'hitl' }, { from: 'hitl', to: 'dlpfc' }], systemState: 'HITL', processingLoad: 40, note: 'HITL activates ‚Üí DLPFC activates ‚Üí User deactivates', duration: 4 },
            { id: 22, step: '22', phase: 'Adaptation', title: 'State Updated', description: 'DLPFC processes feedback from HITL and updates its internal state. This includes adjusting weights, refining strategies, consolidating learnings into memory, and preparing improved responses for future interactions.', active: ['hitl', 'dlpfc'], showHITL: true, selfArrows: ['dlpfc'], arrows: [], dataFlow: [], systemState: 'UPDATING', processingLoad: 55, internalOps: ['Feedback Analysis', 'Weight Adjustment', 'Strategy Refinement', 'Memory Consolidation'], note: 'HITL deactivates ‚Üí DLPFC deactivates', duration: 4 },
            { id: 23, step: '‚Üí', phase: 'Complete', title: 'Cycle Complete', description: 'Full cognitive processing cycle completed. The system has learned from feedback and returns to ready state, awaiting the next user input to begin a new cycle.', active: [], arrows: [], dataFlow: [], systemState: 'READY', processingLoad: 5, canRestart: true, duration: 1 }
        ];

        // State
        let currentStep = 0;
        let isPlaying = false;
        let speed = 2200;
        let playTimeout = null;
        let particleIntervals = [];

        // Initialize
        function init() {
            renderNodes();
            updateUI();
            initTouchGestures();
            checkMobileScrollHint();
        }
        
        // Mobile touch gesture support
        function initTouchGestures() {
            const svgWrapper = document.querySelector('.svg-wrapper');
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            
            svgWrapper.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });
            
            svgWrapper.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });
            
            function handleSwipe() {
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const minSwipeDistance = 50;
                
                // Only handle horizontal swipes (ignore if vertical movement is greater)
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                    if (deltaX > 0) {
                        // Swipe right - previous step
                        prevStep();
                    } else {
                        // Swipe left - next step
                        nextStep();
                    }
                }
            }
            
            // Double tap to play/pause
            let lastTap = 0;
            svgWrapper.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) {
                    togglePlay();
                    e.preventDefault();
                }
                lastTap = currentTime;
            });
        }
        
        // Show scroll hint on mobile
        function checkMobileScrollHint() {
            if (window.innerWidth <= 768) {
                const wrapper = document.querySelector('.svg-wrapper');
                const hint = document.createElement('div');
                hint.className = 'scroll-hint';
                hint.innerHTML = '‚Üê Scroll to view full diagram ‚Üí';
                hint.style.cssText = `
                    text-align: center;
                    padding: 0.5rem;
                    font-size: 0.7rem;
                    color: var(--text-muted);
                    background: rgba(0,0,0,0.3);
                    border-radius: 4px;
                    margin-bottom: 0.5rem;
                `;
                wrapper.parentNode.insertBefore(hint, wrapper);
                
                // Hide hint after first scroll
                wrapper.addEventListener('scroll', () => {
                    hint.style.display = 'none';
                }, { once: true });
                
                // Also hide after 5 seconds
                setTimeout(() => {
                    hint.style.opacity = '0';
                    hint.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => hint.style.display = 'none', 500);
                }, 5000);
            }
        }

        // Render node
        function renderNode(id, x, y, active, hasSelfArrow) {
            const color = colors[id];
            const info = nodeInfo[id];
            const nodeGroup = document.getElementById(`node${id.charAt(0).toUpperCase() + id.slice(1)}`);
            if (!nodeGroup) return;

            nodeGroup.innerHTML = '';

            // Outer glow for active nodes
            if (active) {
                const glow = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                glow.setAttribute('cx', '0');
                glow.setAttribute('cy', '0');
                glow.setAttribute('rx', '75');
                glow.setAttribute('ry', '52');
                glow.setAttribute('fill', color.glow);
                glow.setAttribute('opacity', hasSelfArrow ? '0.6' : '0.4');
                nodeGroup.appendChild(glow);
            }

            // Animated border for processing state
            if (hasSelfArrow) {
                const border = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                border.setAttribute('x', '-68');
                border.setAttribute('y', '-48');
                border.setAttribute('width', '136');
                border.setAttribute('height', '96');
                border.setAttribute('rx', '18');
                border.setAttribute('fill', 'none');
                border.setAttribute('stroke', color.primary);
                border.setAttribute('stroke-width', '2');
                border.setAttribute('stroke-dasharray', '6 4');
                border.setAttribute('opacity', '0.7');
                border.style.animation = 'pulse 1.5s ease-in-out infinite';
                nodeGroup.appendChild(border);

                // Self arrow
                const defs = document.querySelector('defs');
                const markerId = `self-arrow-${id}`;
                if (!document.getElementById(markerId)) {
                    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                    marker.setAttribute('id', markerId);
                    marker.setAttribute('markerWidth', '8');
                    marker.setAttribute('markerHeight', '6');
                    marker.setAttribute('refX', '6');
                    marker.setAttribute('refY', '3');
                    marker.setAttribute('orient', 'auto');
                    const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    polygon.setAttribute('points', '0 0, 8 3, 0 6');
                    polygon.setAttribute('fill', color.primary);
                    marker.appendChild(polygon);
                    defs.appendChild(marker);
                }

                const selfArrow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                selfArrow.setAttribute('d', 'M 50 -28 C 90 -50, 105 0, 90 30 C 80 48, 55 42, 50 30');
                selfArrow.setAttribute('fill', 'none');
                selfArrow.setAttribute('stroke', color.primary);
                selfArrow.setAttribute('stroke-width', '2');
                selfArrow.setAttribute('marker-end', `url(#${markerId})`);
                selfArrow.style.filter = `drop-shadow(0 0 4px ${color.primary})`;
                nodeGroup.appendChild(selfArrow);
            }

            // Shadow for depth
            const shadow = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            shadow.setAttribute('x', '-58');
            shadow.setAttribute('y', '-38');
            shadow.setAttribute('width', '120');
            shadow.setAttribute('height', '84');
            shadow.setAttribute('rx', '14');
            shadow.setAttribute('fill', 'rgba(0, 0, 0, 0.3)');
            shadow.setAttribute('filter', 'blur(8px)');
            shadow.setAttribute('transform', 'translate(2, 4)');
            nodeGroup.appendChild(shadow);

            // Main card background
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', '-60');
            rect.setAttribute('y', '-42');
            rect.setAttribute('width', '120');
            rect.setAttribute('height', '84');
            rect.setAttribute('rx', '14');
            rect.setAttribute('fill', active ? `url(#gradient-${id})` : 'rgba(30, 30, 34, 0.95)');
            rect.setAttribute('stroke', active ? color.primary : 'rgba(255, 255, 255, 0.06)');
            rect.setAttribute('stroke-width', active ? '1.5' : '1');
            rect.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            nodeGroup.appendChild(rect);

            // Inner border highlight
            const innerBorder = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            innerBorder.setAttribute('x', '-58');
            innerBorder.setAttribute('y', '-40');
            innerBorder.setAttribute('width', '116');
            innerBorder.setAttribute('height', '80');
            innerBorder.setAttribute('rx', '12');
            innerBorder.setAttribute('fill', 'none');
            innerBorder.setAttribute('stroke', active ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.03)');
            innerBorder.setAttribute('stroke-width', '1');
            nodeGroup.appendChild(innerBorder);

            // Icon container circle
            const iconBg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            iconBg.setAttribute('cx', '0');
            iconBg.setAttribute('cy', '-12');
            iconBg.setAttribute('r', '18');
            iconBg.setAttribute('fill', active ? `${color.primary}20` : 'rgba(255,255,255,0.03)');
            iconBg.setAttribute('stroke', active ? `${color.primary}40` : 'rgba(255,255,255,0.05)');
            iconBg.setAttribute('stroke-width', '1');
            nodeGroup.appendChild(iconBg);

            // SVG Icon
            const iconGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            iconGroup.setAttribute('transform', 'translate(-10, -22) scale(0.85)');
            const iconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            iconPath.setAttribute('d', iconPaths[info.icon] || iconPaths.brain);
            iconPath.setAttribute('fill', active ? color.primary : '#52525b');
            iconPath.setAttribute('stroke', 'none');
            iconPath.style.transition = 'fill 0.4s ease';
            iconGroup.appendChild(iconPath);
            nodeGroup.appendChild(iconGroup);

            // Module name
            const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            name.setAttribute('y', '18');
            name.setAttribute('text-anchor', 'middle');
            name.setAttribute('fill', active ? '#f4f4f5' : '#71717a');
            name.setAttribute('font-size', '12');
            name.setAttribute('font-weight', '600');
            name.setAttribute('letter-spacing', '0.5');
            name.textContent = info.name;
            name.style.transition = 'fill 0.4s ease';
            nodeGroup.appendChild(name);

            // Full name subtitle (only when active)
            if (active && info.fullName) {
                const subtitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                subtitle.setAttribute('y', '32');
                subtitle.setAttribute('text-anchor', 'middle');
                subtitle.setAttribute('fill', '#a1a1aa');
                subtitle.setAttribute('font-size', '7');
                subtitle.setAttribute('font-weight', '400');
                subtitle.textContent = info.fullName.length > 22 ? info.fullName.substring(0, 20) + '...' : info.fullName;
                nodeGroup.appendChild(subtitle);
            }

            // Status indicator
            if (active) {
                const statusGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                statusGroup.setAttribute('transform', 'translate(42, -32)');
                
                // Outer ring
                const ring = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                ring.setAttribute('r', '8');
                ring.setAttribute('fill', 'rgba(0,0,0,0.3)');
                ring.setAttribute('stroke', hasSelfArrow ? '#10b981' : color.primary);
                ring.setAttribute('stroke-width', '1.5');
                statusGroup.appendChild(ring);
                
                // Inner dot
                const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                dot.setAttribute('r', '4');
                dot.setAttribute('fill', hasSelfArrow ? '#10b981' : color.primary);
                dot.style.filter = `drop-shadow(0 0 4px ${hasSelfArrow ? '#10b981' : color.primary})`;
                statusGroup.appendChild(dot);
                
                nodeGroup.appendChild(statusGroup);
            }
        }

        // Render all nodes
        function renderNodes() {
            const stepData = steps[currentStep];
            const activeNodes = stepData.active || [];
            const selfArrows = stepData.selfArrows || [];

            ['user', 'dlpfc', 'vmpfc', 'ofc', 'acc', 'mpfc', 'integration'].forEach(id => {
                const pos = positions[id];
                renderNode(id, pos.x, pos.y, activeNodes.includes(id), selfArrows.includes(id));
            });
        }

        // Render arrows
        function renderArrows() {
            const container = document.getElementById('arrowsContainer');
            container.innerHTML = '';
            
            const labelsContainer = document.getElementById('labelsContainer');
            labelsContainer.innerHTML = '';
            
            // Track placed labels for label-to-label collision detection
            const placedLabels = [];
            
            const stepData = steps[currentStep];
            if (!stepData.arrows) return;

            const totalArrows = stepData.arrows.length;

            stepData.arrows.forEach((arrow, idx) => {
                const start = positions[arrow.from];
                const end = positions[arrow.to];
                if (!start || !end) return;

                const dx = end.x - start.x;
                const dy = end.y - start.y;
                const angle = Math.atan2(dy, dx);
                const lineLength = Math.sqrt(dx * dx + dy * dy);

                const startOffset = arrow.from === 'hitl' ? 58 : 65;
                const endOffset = arrow.to === 'hitl' ? 58 : 65;
                const startYOffset = arrow.from === 'hitl' ? 35 : 45;
                const endYOffset = arrow.to === 'hitl' ? 35 : 45;

                const startX = start.x + Math.cos(angle) * startOffset;
                const startY = start.y + Math.sin(angle) * startYOffset;
                const endX = end.x - Math.cos(angle) * endOffset;
                const endY = end.y - Math.sin(angle) * endYOffset;

                // Calculate label position along the line (spread out if multiple arrows)
                let labelPosition = 0.5;
                if (totalArrows > 1) {
                    labelPosition = 0.25 + (idx * 0.5 / (totalArrows - 1 || 1));
                }
                
                const labelX = startX + (endX - startX) * labelPosition;
                const labelY = startY + (endY - startY) * labelPosition;

                // Dynamic label positioning with collision detection
                const labelWidth = arrow.label ? arrow.label.length * 6.5 + 24 : 0;
                const labelHeight = 24;
                
                // Node bounding boxes for collision detection
                const nodeBounds = Object.entries(positions).map(([id, pos]) => ({
                    id,
                    left: pos.x - 65,
                    right: pos.x + 65,
                    top: pos.y - 50,
                    bottom: pos.y + 50
                }));
                
                // Check if a label position collides with any node OR other labels
                function checkCollision(x, y, w, h) {
                    const labelLeft = x - w/2 - 4;
                    const labelRight = x + w/2 + 4;
                    const labelTop = y - h/2 - 4;
                    const labelBottom = y + h/2 + 4;
                    
                    // Check nodes
                    for (const node of nodeBounds) {
                        if (labelRight > node.left && labelLeft < node.right &&
                            labelBottom > node.top && labelTop < node.bottom) {
                            return true;
                        }
                    }
                    
                    // Check other placed labels
                    for (const placed of placedLabels) {
                        if (labelRight > placed.left && labelLeft < placed.right &&
                            labelBottom > placed.top && labelTop < placed.bottom) {
                            return true;
                        }
                    }
                    
                    return false;
                }
                
                // Try different offset positions until we find one without collision
                const perpAngle = angle + Math.PI / 2;
                const offsets = [
                    { x: 0, y: -40 },  // Above
                    { x: 0, y: 40 },   // Below
                    { x: Math.cos(perpAngle) * 45, y: Math.sin(perpAngle) * 45 },  // Perpendicular +
                    { x: Math.cos(perpAngle) * -45, y: Math.sin(perpAngle) * -45 }, // Perpendicular -
                    { x: Math.cos(perpAngle) * 60, y: Math.sin(perpAngle) * 60 },  // Further perpendicular +
                    { x: Math.cos(perpAngle) * -60, y: Math.sin(perpAngle) * -60 }, // Further perpendicular -
                    { x: 0, y: -60 },  // Further above
                    { x: 0, y: 60 },   // Further below
                    { x: -50, y: -30 }, // Upper left
                    { x: 50, y: -30 },  // Upper right
                    { x: -50, y: 30 },  // Lower left
                    { x: 50, y: 30 },   // Lower right
                ];
                
                let labelOffsetX = 0;
                let labelOffsetY = -40; // Default to above
                
                // Find first non-colliding position
                for (const offset of offsets) {
                    const testX = labelX + offset.x;
                    const testY = labelY + offset.y;
                    if (!checkCollision(testX, testY, labelWidth, labelHeight)) {
                        labelOffsetX = offset.x;
                        labelOffsetY = offset.y;
                        break;
                    }
                }

                const color = colors[arrow.from]?.primary || '#888';
                const endColor = colors[arrow.to]?.primary || '#888';

                // Create gradient
                const gradId = `arrow-grad-${arrow.from}-${arrow.to}-${currentStep}`;
                const defs = document.querySelector('defs');
                const grad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                grad.setAttribute('id', gradId);
                grad.setAttribute('x1', '0%');
                grad.setAttribute('y1', '0%');
                grad.setAttribute('x2', '100%');
                grad.setAttribute('y2', '0%');
                const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop1.setAttribute('offset', '0%');
                stop1.setAttribute('stop-color', color);
                const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop2.setAttribute('offset', '100%');
                stop2.setAttribute('stop-color', endColor);
                grad.appendChild(stop1);
                grad.appendChild(stop2);
                defs.appendChild(grad);

                // Create marker
                const markerId = `arrowhead-${arrow.from}-${arrow.to}-${currentStep}`;
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                marker.setAttribute('id', markerId);
                marker.setAttribute('markerWidth', '10');
                marker.setAttribute('markerHeight', '7');
                marker.setAttribute('refX', '9');
                marker.setAttribute('refY', '3.5');
                marker.setAttribute('orient', 'auto');
                const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
                polygon.setAttribute('fill', endColor);
                marker.appendChild(polygon);
                defs.appendChild(marker);

                // Create line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', startX);
                line.setAttribute('y1', startY);
                line.setAttribute('x2', endX);
                line.setAttribute('y2', endY);
                line.setAttribute('stroke', `url(#${gradId})`);
                line.setAttribute('stroke-width', arrow.highlight ? '3.5' : '2.5');
                line.setAttribute('marker-end', `url(#${markerId})`);
                if (arrow.highlight) {
                    line.style.filter = `drop-shadow(0 0 8px ${color})`;
                }
                line.classList.add('arrow-line');
                container.appendChild(line);

                // Create label with smart positioning
                if (arrow.label) {
                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    const finalLabelX = labelX + labelOffsetX;
                    const finalLabelY = labelY + labelOffsetY;
                    g.setAttribute('transform', `translate(${finalLabelX}, ${finalLabelY})`);
                    
                    const labelRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    const actualLabelWidth = arrow.label.length * 6.5 + 24;
                    labelRect.setAttribute('x', -actualLabelWidth / 2);
                    labelRect.setAttribute('y', '-12');
                    labelRect.setAttribute('width', actualLabelWidth);
                    labelRect.setAttribute('height', '24');
                    labelRect.setAttribute('rx', '6');
                    labelRect.setAttribute('fill', arrow.highlight ? 'rgba(16, 185, 129, 0.2)' : 'rgba(24, 24, 27, 0.98)');
                    labelRect.setAttribute('stroke', arrow.highlight ? '#10b981' : color);
                    labelRect.setAttribute('stroke-width', arrow.highlight ? '2' : '1');
                    g.appendChild(labelRect);

                    const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    labelText.setAttribute('text-anchor', 'middle');
                    labelText.setAttribute('y', '4');
                    labelText.setAttribute('fill', '#f4f4f5');
                    labelText.setAttribute('font-size', '9');
                    labelText.setAttribute('font-weight', arrow.highlight ? 'bold' : '500');
                    labelText.textContent = arrow.label;
                    g.appendChild(labelText);

                    labelsContainer.appendChild(g);
                    
                    // Track this label for collision detection with subsequent labels
                    placedLabels.push({
                        left: finalLabelX - actualLabelWidth/2,
                        right: finalLabelX + actualLabelWidth/2,
                        top: finalLabelY - 12,
                        bottom: finalLabelY + 12
                    });
                }
            });
        }

        // Start continuous particle animation
        function startParticles() {
            stopParticles();
            
            const stepData = steps[currentStep];
            if (!stepData.dataFlow || stepData.dataFlow.length === 0) return;

            stepData.dataFlow.forEach((flow, flowIdx) => {
                const interval = setInterval(() => {
                    createParticle(flow.from, flow.to);
                }, 600 + flowIdx * 200);
                particleIntervals.push(interval);
            });

            // Also create initial particles immediately
            stepData.dataFlow.forEach((flow, flowIdx) => {
                setTimeout(() => createParticle(flow.from, flow.to), flowIdx * 150);
            });
        }

        // Stop particle animation
        function stopParticles() {
            particleIntervals.forEach(interval => clearInterval(interval));
            particleIntervals = [];
        }

        // Create a single particle
        function createParticle(from, to) {
            const container = document.getElementById('particlesContainer');
            const start = positions[from];
            const end = positions[to];
            if (!start || !end) return;

            const dx = end.x - start.x;
            const dy = end.y - start.y;
            const angle = Math.atan2(dy, dx);

            const startOffset = from === 'hitl' ? 58 : 65;
            const endOffset = to === 'hitl' ? 58 : 65;
            const startYOffset = from === 'hitl' ? 35 : 45;
            const endYOffset = to === 'hitl' ? 35 : 45;

            const startX = start.x + Math.cos(angle) * startOffset;
            const startY = start.y + Math.sin(angle) * startYOffset;
            const endX = end.x - Math.cos(angle) * endOffset;
            const endY = end.y - Math.sin(angle) * endYOffset;

            const color = colors[from]?.primary || '#fff';

            // Create path for motion
            const pathId = `particle-path-${Date.now()}-${Math.random()}`;
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('id', pathId);
            path.setAttribute('d', `M ${startX} ${startY} L ${endX} ${endY}`);
            path.setAttribute('fill', 'none');
            path.setAttribute('stroke', 'none');
            container.appendChild(path);

            // Create particle group
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            
            // Outer glow
            const glow = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            glow.setAttribute('r', '6');
            glow.setAttribute('fill', color);
            glow.style.filter = `drop-shadow(0 0 8px ${color})`;
            g.appendChild(glow);

            // Inner dot
            const inner = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            inner.setAttribute('r', '2.5');
            inner.setAttribute('fill', '#fff');
            g.appendChild(inner);

            g.style.offsetPath = `path('M ${startX} ${startY} L ${endX} ${endY}')`;
            g.style.animation = 'particleMove 1.2s linear forwards';
            container.appendChild(g);

            // Remove after animation
            setTimeout(() => {
                g.remove();
                path.remove();
            }, 1200);
        }

        // Update UI
        function updateUI() {
            const stepData = steps[currentStep];

            // Status
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const statusColor = stateColors[stepData.systemState] || '#71717a';
            statusDot.style.backgroundColor = statusColor;
            statusDot.style.boxShadow = `0 0 12px ${statusColor}`;
            statusText.style.color = statusColor;
            statusText.textContent = stepData.systemState;

            // Panel
            document.getElementById('phaseBadge').textContent = stepData.phase;
            document.getElementById('phaseBadge').style.backgroundColor = `${statusColor}20`;
            document.getElementById('phaseBadge').style.color = statusColor;
            document.getElementById('phaseBadge').style.border = `1px solid ${statusColor}40`;
            document.getElementById('stepLabel').textContent = `Step ${stepData.step}`;
            document.getElementById('panelTitle').textContent = stepData.title;
            document.getElementById('panelDescription').textContent = stepData.description;

            // Note
            const noteSection = document.getElementById('noteSection');
            if (stepData.note) {
                noteSection.style.display = 'block';
                document.getElementById('noteText').textContent = stepData.note;
            } else {
                noteSection.style.display = 'none';
            }

            // Load bar
            document.getElementById('loadValue').textContent = `${stepData.processingLoad}%`;
            const loadBarFill = document.getElementById('loadBarFill');
            loadBarFill.style.width = `${stepData.processingLoad}%`;
            loadBarFill.style.background = `linear-gradient(90deg, ${statusColor}, ${statusColor}88)`;
            loadBarFill.style.boxShadow = `0 0 12px ${statusColor}60`;

            // Internal ops
            const opsSection = document.getElementById('opsSection');
            if (stepData.internalOps && stepData.internalOps.length > 0) {
                opsSection.style.display = 'block';
                const opsList = document.getElementById('opsList');
                opsList.innerHTML = '';
                stepData.internalOps.forEach((op, idx) => {
                    const div = document.createElement('div');
                    div.className = 'op-item';
                    div.style.animationDelay = `${idx * 0.08}s`;
                    div.innerHTML = `<div class="op-dot" style="background-color: ${statusColor}; box-shadow: 0 0 8px ${statusColor};"></div><span>${op}</span>`;
                    opsList.appendChild(div);
                });
            } else {
                opsSection.style.display = 'none';
            }

            // Active components
            const activeSection = document.getElementById('activeSection');
            if (stepData.active && stepData.active.length > 0) {
                activeSection.style.display = 'block';
                const activeComponents = document.getElementById('activeComponents');
                activeComponents.innerHTML = '';
                stepData.active.forEach(id => {
                    const color = colors[id];
                    const hasSelf = stepData.selfArrows?.includes(id);
                    const span = document.createElement('span');
                    span.className = 'component-badge';
                    span.style.backgroundColor = `${color.primary}15`;
                    span.style.color = color.primary;
                    span.style.border = `1px solid ${color.primary}40`;
                    span.innerHTML = `${nodeInfo[id].name}${hasSelf ? ' <span style="font-size: 10px;">‚Üª</span>' : ''}`;
                    activeComponents.appendChild(span);
                });
            } else {
                activeSection.style.display = 'none';
            }

            // Data flow
            const flowSection = document.getElementById('flowSection');
            if (stepData.arrows && stepData.arrows.length > 0) {
                flowSection.style.display = 'block';
                const dataFlowList = document.getElementById('dataFlowList');
                dataFlowList.innerHTML = '';
                stepData.arrows.forEach(arrow => {
                    const div = document.createElement('div');
                    div.className = 'data-flow-item';
                    div.innerHTML = `
                        <span style="color: ${colors[arrow.from]?.primary}; font-weight: 600;">${nodeInfo[arrow.from]?.name}</span>
                        <span class="flow-arrow">‚Üí</span>
                        <span style="color: ${colors[arrow.to]?.primary}; font-weight: 600;">${nodeInfo[arrow.to]?.name}</span>
                        ${arrow.label ? `<span class="flow-label">(${arrow.label})</span>` : ''}
                    `;
                    dataFlowList.appendChild(div);
                });
            } else {
                flowSection.style.display = 'none';
            }

            // HITL
            document.getElementById('hitlSection').style.display = stepData.showHITL ? 'block' : 'none';
            document.getElementById('hitlNode').style.display = stepData.showHITL ? 'block' : 'none';
            document.getElementById('hitlBridgeLabel').style.display = stepData.showHITL ? 'block' : 'none';

            // Loop indicator
            const loopIndicator = document.getElementById('loopIndicator');
            if (stepData.loop) {
                loopIndicator.style.display = 'block';
                document.getElementById('loopLabel').textContent = stepData.loopLabel || '';
            } else {
                loopIndicator.style.display = 'none';
            }

            // Progress bar
            const progressBar = document.getElementById('progressBar');
            const progress = Math.max(6, (currentStep / (steps.length - 1)) * 740);
            progressBar.setAttribute('width', progress);

            // Step display
            document.getElementById('currentStepDisplay').textContent = stepData.step;

            // Buttons
            document.getElementById('prevBtn').disabled = currentStep === 0;
            document.getElementById('nextBtn').disabled = currentStep === steps.length - 1;
            document.getElementById('restartBtn').style.display = stepData.canRestart ? 'inline-block' : 'none';

            // Play button
            const playBtn = document.getElementById('playBtn');
            if (isPlaying) {
                playBtn.textContent = '‚è∏ Pause';
                playBtn.classList.remove('premium-btn');
                playBtn.style.background = '#dc2626';
            } else {
                playBtn.textContent = '‚ñ∂ Play';
                playBtn.classList.add('premium-btn');
                playBtn.style.background = '';
            }

            // Render visualization
            renderNodes();
            renderArrows();
            startParticles();
        }

        // Control functions
        function togglePlay() {
            isPlaying = !isPlaying;
            if (isPlaying) {
                playStep();
            } else {
                clearTimeout(playTimeout);
            }
            updateUI();
        }

        function playStep() {
            if (!isPlaying) return;
            
            const stepData = steps[currentStep];
            const duration = speed * (stepData.duration || 1);
            
            playTimeout = setTimeout(() => {
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    updateUI();
                    playStep();
                } else {
                    isPlaying = false;
                    updateUI();
                }
            }, duration);
        }

        function nextStep() {
            if (currentStep < steps.length - 1) {
                currentStep++;
                updateUI();
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                updateUI();
            }
        }

        function resetAnimation() {
            isPlaying = false;
            clearTimeout(playTimeout);
            currentStep = 0;
            updateUI();
        }

        function restartCycle() {
            currentStep = 1;
            isPlaying = true;
            updateUI();
            playStep();
        }

        function updateSpeed() {
            const slider = document.getElementById('speedSlider');
            speed = 4800 - Number(slider.value);
        }

        function togglePanel() {
            const panel = document.getElementById('sidePanel');
            const btn = document.getElementById('togglePanel');
            panel.classList.toggle('visible');
            btn.classList.toggle('active');
            btn.textContent = panel.classList.contains('visible') ? 'Hide Panel' : 'Show Panel';
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
